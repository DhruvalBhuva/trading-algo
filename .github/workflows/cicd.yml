# ====================================================
# Workflow Name (shown in GitHub Actions UI)
# ====================================================
name: Build, Push & Deploy Trading Bot

# ====================================================
# Trigger conditions
# ====================================================
on:
  # Automatically run on every push to main branch
  push:
    branches: [main]

  # Allow manual execution from GitHub UI
  workflow_dispatch:

# ====================================================
# Global environment variables
# ====================================================
env:
  # Docker Hub image name (username/repository)
  DOCKER_IMAGE_NAME: dhruvabhuva/trading-algo

# ====================================================
# Jobs
# ====================================================
jobs:
  build-and-deploy:
    # OS runner provided by GitHub
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------
      # 1️⃣ Checkout repository code
      # ------------------------------------------------
      - name: 1. Checkout Code
        # Why:
        # The GitHub runner starts empty.
        # This step pulls your repo code into the runner.
        uses: actions/checkout@v4

      # ------------------------------------------------
      # 2️⃣ Enable multi-arch builds (future-proof)
      # ------------------------------------------------
      - name: 2. Set up QEMU
        # Why:
        # Allows building images for different CPU architectures.
        uses: docker/setup-qemu-action@v3

      # ------------------------------------------------
      # 3️⃣ Enable Docker Buildx
      # ------------------------------------------------
      - name: 3. Set up Docker Buildx
        # Why:
        # Enables faster builds, caching, and advanced features.
        uses: docker/setup-buildx-action@v3

      # ------------------------------------------------
      # 4️⃣ Login to Docker Hub
      # ------------------------------------------------
      - name: 4. Log in to Docker Hub
        # Why:
        # Required to push Docker images to your Docker Hub account.
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ------------------------------------------------
      # 5️⃣ Generate image tags (commit hash + latest)
      # ------------------------------------------------
      - name: 5. Generate Docker Metadata
        # Why:
        # - git-<sha> allows exact rollback
        # - latest is used for production deploy
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=sha,prefix=git-
            type=raw,value=latest

      # ------------------------------------------------
      # 6️⃣ Build & push Docker image
      # ------------------------------------------------
      - name: 6. Build and Push Docker Image
        # Why:
        # - Builds Dockerfile
        # - Tags image
        # - Pushes to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # ------------------------------------------------
      # 7️⃣ Deploy on DigitalOcean server
      # ------------------------------------------------
      - name: 7. Deploy via SSH
        # Why:
        # - Pull latest image
        # - Restart container using docker-compose
        # - Fully automatic deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /app
            docker compose pull
            docker compose up -d
